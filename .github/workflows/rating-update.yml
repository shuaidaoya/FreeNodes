name: ⭐ Rating Aggregation

on:
  workflow_dispatch:
  schedule:
    - cron: '0 * * * *'
  issues:
    types: [opened]

permissions:
  contents: write
  issues: read

jobs:
  build-rating:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - uses: actions/github-script@v7
        id: calc
        with:
          script: |
            const rest = github.rest
            async function listAll() {
              const res = await rest.issues.listForRepo({ owner: context.repo.owner, repo: context.repo.repo, state: 'all', labels: 'rating', per_page: 100 })
              return res.data
            }
            const issues = await listAll()
            const nums = []
            for (const it of issues) {
              const m = /rating:\s*([0-9]+(?:\.[0-9]+)?)/i.exec(it.body || '')
              if (m) nums.push(parseFloat(m[1]))
            }
            const avg = nums.length ? Math.round((nums.reduce((a,b)=>a+b,0)/nums.length)*10)/10 : 0
            core.setOutput('avg', String(avg))
      - name: Generate SVG
        run: |
          node -e "
          const fs=require('fs')
          const avg=parseFloat(process.env.AVG||'0')
          const size=32, gap=8
          const w=size*5+gap*4, h=size
          function starPath(x,y,s){
            const p=[
              [0.5,0],[0.618,0.382],[1,0.382],[0.691,0.618],[0.809,1],[0.5,0.764],[0.191,1],[0.309,0.618],[0,0.382],[0.382,0.382]
            ].map(([xx,yy])=>[(x+xx*s),(y+yy*s)])
            return 'M'+p.map(([a,b])=>a+','+b).join('L')+'Z'
          }
          let svg=`<svg xmlns='http://www.w3.org/2000/svg' width='${w}' height='${h}' viewBox='0 0 ${w} ${h}'>`
          for(let i=0;i<5;i++){
            const x=i*(size+gap), y=0, frac=Math.max(0,Math.min(1,avg-i))
            const id='clip'+i
            svg+=`<defs><clipPath id='${id}'><path d='${starPath(x,y,size)}'/></clipPath></defs>`
            svg+=`<rect x='${x}' y='${y}' width='${size}' height='${size}' fill='#ddd'/>`
            svg+=`<rect x='${x}' y='${y}' width='${size*frac}' height='${size}' fill='#FFC107' clip-path='url(#${id})'/>`
            svg+=`<path d='${starPath(x,y,size)}' fill='none' stroke='#888' stroke-width='1'/>`
          }
          svg+='</svg>'
          fs.mkdirSync('assets',{recursive:true})
          fs.writeFileSync('assets/rating.svg',svg)
          "
        env:
          AVG: ${{ steps.calc.outputs.avg }}
      - name: Update README
        run: |
          avg='${{ steps.calc.outputs.avg }}'
          if [ -f README.md ]; then
            sed -i -E "s|(<!-- RATING_AVG_START -->)(.*?)(<!-- RATING_AVG_END -->)|\1${avg}\3|g" README.md
          fi
      - name: Commit changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            git config user.email "action@github.com"
            git config user.name "GitHub Action"
            git add README.md assets/rating.svg
            git commit -m "⭐ 更新项目评分为 ${{ steps.calc.outputs.avg }}"
            git push
          fi
