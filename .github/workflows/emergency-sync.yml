name: ðŸš¨ ç´§æ€¥æ¢å¤åŒæ­¥

on:
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘ç´§æ€¥æ¢å¤

permissions:
  contents: write
  actions: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  emergency-check:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      TZ: Asia/Shanghai
    
    steps:
    - name: ï¿½ æ£€æŸ¥æœ€è¿‘æˆåŠŸè¿è¡Œï¼ˆGitHub APIï¼‰
      id: api_check
      uses: actions/github-script@v7
      with:
        script: |
          const { rest } = github;
          async function lastSuccess(workflowFile) {
            const runs = await rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: workflowFile,
              status: 'success',
              per_page: 1
            });
            return runs.data.workflow_runs[0]?.updated_at;
          }
          const mainUpdated = await lastSuccess('sync-gist.yml');
          const backupUpdated = await lastSuccess('sync-gist-backup.yml');
          const latest = [mainUpdated, backupUpdated].filter(Boolean).sort().pop();
          core.setOutput('main_updated', mainUpdated || '');
          core.setOutput('backup_updated', backupUpdated || '');
          core.setOutput('latest_updated', latest || '');
    - name: ðŸ§® ç´§æ€¥çŠ¶æ€åˆ¤æ–­
      id: emergency_check
      run: |
        latest='${{ steps.api_check.outputs.latest_updated }}'
        if [ -n "$latest" ]; then
          last_ts=$(date -d "$latest" +%s)
          now_ts=$(date +%s)
          diff=$(( (now_ts - last_ts) / 60 ))
          echo "TIME_SINCE_LAST=$diff" >> $GITHUB_OUTPUT
          if [ "$diff" -gt 90 ]; then
            echo "EMERGENCY_REQUIRED=true" >> $GITHUB_OUTPUT
            echo "EMERGENCY_REASON=æœ€è¿‘æˆåŠŸè¿è¡Œå·²è¶…è¿‡90åˆ†é’Ÿ" >> $GITHUB_OUTPUT
          else
            echo "EMERGENCY_REQUIRED=false" >> $GITHUB_OUTPUT
            echo "EMERGENCY_REASON=è¿è¡Œæ­£å¸¸" >> $GITHUB_OUTPUT
          fi
        else
          echo "EMERGENCY_REQUIRED=true" >> $GITHUB_OUTPUT
          echo "EMERGENCY_REASON=æœªæŸ¥è¯¢åˆ°æˆåŠŸè¿è¡Œè®°å½•" >> $GITHUB_OUTPUT
          echo "TIME_SINCE_LAST=unknown" >> $GITHUB_OUTPUT
        fi
        echo "TRIGGER_TYPE=${{ github.event_name }}" >> $GITHUB_OUTPUT
        
    - name: ðŸ“Š ç´§æ€¥çŠ¶æ€æŠ¥å‘Š
      run: |
        echo "## ðŸš¨ ç´§æ€¥æ¢å¤çŠ¶æ€æ£€æŸ¥" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**æ£€æŸ¥æ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S åŒ—äº¬æ—¶é—´')" >> $GITHUB_STEP_SUMMARY
        echo "**è§¦å‘æ–¹å¼**: ${{ steps.emergency_check.outputs.TRIGGER_TYPE }}" >> $GITHUB_STEP_SUMMARY
        echo "**è·ç¦»ä¸Šæ¬¡æ›´æ–°**: ${{ steps.emergency_check.outputs.TIME_SINCE_LAST }} åˆ†é’Ÿ" >> $GITHUB_STEP_SUMMARY
        echo "**æ˜¯å¦éœ€è¦ç´§æ€¥æ¢å¤**: ${{ steps.emergency_check.outputs.EMERGENCY_REQUIRED }}" >> $GITHUB_STEP_SUMMARY
        echo "**æ£€æŸ¥ç»“æžœ**: ${{ steps.emergency_check.outputs.EMERGENCY_REASON }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.emergency_check.outputs.EMERGENCY_REQUIRED }}" = "true" ]; then
          echo "ðŸš¨ **éœ€è¦ç«‹å³æ‰§è¡Œç´§æ€¥æ¢å¤ï¼**" >> $GITHUB_STEP_SUMMARY
        else
          echo "âœ… **ç³»ç»Ÿè¿è¡Œæ­£å¸¸ï¼Œæ— éœ€ç´§æ€¥æ¢å¤**" >> $GITHUB_STEP_SUMMARY
        fi

    - name: ðŸš¨ è§¦å‘ä¸»/å¤‡ç”¨å·¥ä½œæµ
      if: steps.emergency_check.outputs.EMERGENCY_REQUIRED == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const { rest } = github;
          try {
            await rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'sync-gist.yml',
              ref: 'main',
              inputs: { emergency_trigger: 'true' }
            });
            core.setOutput('MAIN_TRIGGER_SUCCESS', true);
          } catch (e) {
            core.setOutput('MAIN_TRIGGER_SUCCESS', false);
            try {
              await rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'sync-gist-backup.yml',
                ref: 'main',
                inputs: { emergency_trigger: 'true' }
              });
              core.setOutput('BACKUP_TRIGGER_SUCCESS', true);
            } catch (e2) {
              core.setOutput('BACKUP_TRIGGER_SUCCESS', false);
            }
          }
    - name: ðŸ“ è®°å½•ç´§æ€¥æ¢å¤æ—¥å¿—å¹¶ä¸Šä¼ 
      if: steps.emergency_check.outputs.EMERGENCY_REQUIRED == 'true'
      run: |
        echo "æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')" > emergency_recovery.log
        echo "åŽŸå› : ${{ steps.emergency_check.outputs.EMERGENCY_REASON }}" >> emergency_recovery.log
        echo "æœ€è¿‘æˆåŠŸè¿è¡Œ: ${{ steps.api_check.outputs.latest_updated }}" >> emergency_recovery.log
        echo "è·ç¦»ä¸Šæ¬¡æˆåŠŸ: ${{ steps.emergency_check.outputs.TIME_SINCE_LAST }} åˆ†é’Ÿ" >> emergency_recovery.log
      
    - name: ðŸ“¦ ä¸Šä¼ ç´§æ€¥æ¢å¤æ—¥å¿—
      if: steps.emergency_check.outputs.EMERGENCY_REQUIRED == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: emergency-recovery
        path: emergency_recovery.log
        
    - name: ï¿½ è‹¥è§¦å‘å¤±è´¥åˆ™ç›´æŽ¥æ‰§è¡Œæ ¸å¿ƒåŒæ­¥
      if: steps.emergency_check.outputs.EMERGENCY_REQUIRED == 'true'
      uses: ./.github/workflows/sync-core.yml
      with:
        label: ç´§æ€¥æ¢å¤
        dry_run: false
        
    - name: ðŸ“‹ ç´§æ€¥æ¢å¤æ€»ç»“
      run: |
        echo "## ðŸš¨ ç´§æ€¥æ¢å¤æ‰§è¡Œç»“æžœ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**æ‰§è¡Œæ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S åŒ—äº¬æ—¶é—´')" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.emergency_check.outputs.EMERGENCY_REQUIRED }}" = "true" ]; then
          echo "**æ¢å¤çŠ¶æ€**: ðŸš¨ å·²æ‰§è¡Œç´§æ€¥æ¢å¤" >> $GITHUB_STEP_SUMMARY
          echo "**æ¢å¤åŽŸå› **: ${{ steps.emergency_check.outputs.EMERGENCY_REASON }}" >> $GITHUB_STEP_SUMMARY
          echo "**è·ç¦»ä¸Šæ¬¡æ›´æ–°**: ${{ steps.emergency_check.outputs.TIME_SINCE_LAST }} åˆ†é’Ÿ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”§ æ¢å¤æŽªæ–½" >> $GITHUB_STEP_SUMMARY
          echo "1. âœ… æ£€æŸ¥æœ€è¿‘æˆåŠŸè¿è¡Œè®°å½•" >> $GITHUB_STEP_SUMMARY
          echo "2. âœ… å°è¯•è§¦å‘ä¸»/å¤‡ç”¨å·¥ä½œæµ" >> $GITHUB_STEP_SUMMARY
          echo "3. âœ… è‹¥å¤±è´¥åˆ™è°ƒç”¨æ ¸å¿ƒåŒæ­¥" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ‰ **ç´§æ€¥æ¢å¤å®Œæˆï¼ç³»ç»Ÿå·²æ¢å¤æ­£å¸¸è¿è¡Œ**" >> $GITHUB_STEP_SUMMARY
        else
          echo "**æ£€æŸ¥ç»“æžœ**: âœ… ç³»ç»Ÿè¿è¡Œæ­£å¸¸" >> $GITHUB_STEP_SUMMARY
          echo "**è·ç¦»ä¸Šæ¬¡æ›´æ–°**: ${{ steps.emergency_check.outputs.TIME_SINCE_LAST }} åˆ†é’Ÿ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ’š **æ— éœ€ç´§æ€¥æ¢å¤ï¼Œç³»ç»Ÿè¿è¡Œæ­£å¸¸**" >> $GITHUB_STEP_SUMMARY
        fi
