name: ğŸš¨ ç´§æ€¥æ¢å¤åŒæ­¥

on:
  schedule:
    # æ¯2å°æ—¶æ£€æŸ¥ä¸€æ¬¡æ˜¯å¦éœ€è¦ç´§æ€¥æ¢å¤
    - cron: '0 */2 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘ç´§æ€¥æ¢å¤

# è®¾ç½®æƒé™
permissions:
  contents: write
  actions: write

jobs:
  emergency-check:
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Shanghai
    
    steps:
    - name: ğŸ“¦ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        token: ${{ github.token }}
        fetch-depth: 0
        
    - name: ğŸš¨ ç´§æ€¥çŠ¶æ€æ£€æŸ¥
      id: emergency_check
      run: |
        echo "ğŸš¨ å¼€å§‹ç´§æ€¥çŠ¶æ€æ£€æŸ¥..."
        
        # è·å–æœ€åæ›´æ–°æ—¶é—´
        if [ -f "README.md" ]; then
          LAST_UPDATE=$(grep -o '[0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\} [0-9]\{2\}:[0-9]\{2\}:[0-9]\{2\}' README.md | tail -1)
          if [ -n "$LAST_UPDATE" ]; then
            echo "ğŸ“… æœ€åæ›´æ–°æ—¶é—´: $LAST_UPDATE"
            
            # è®¡ç®—æ—¶é—´å·®ï¼ˆåˆ†é’Ÿï¼‰
            CURRENT_TIME=$(date '+%Y-%m-%d %H:%M:%S')
            LAST_TIMESTAMP=$(date -d "$LAST_UPDATE" +%s 2>/dev/null || echo "0")
            CURRENT_TIMESTAMP=$(date -d "$CURRENT_TIME" +%s)
            TIME_DIFF=$(( (CURRENT_TIMESTAMP - LAST_TIMESTAMP) / 60 ))
            
            echo "â° å½“å‰æ—¶é—´: $CURRENT_TIME"
            echo "â±ï¸ æ—¶é—´é—´éš”: $TIME_DIFF åˆ†é’Ÿ"
            
            # ç´§æ€¥æ¢å¤åˆ¤æ–­æ ‡å‡†
            if [ "$TIME_DIFF" -gt 90 ]; then
              echo "ğŸš¨ ç´§æ€¥æƒ…å†µï¼šè·ç¦»ä¸Šæ¬¡æ›´æ–°è¶…è¿‡90åˆ†é’Ÿï¼"
              echo "ğŸ”§ ä¸»è§¦å‘å™¨å’Œå¤‡ç”¨è§¦å‘å™¨å¯èƒ½éƒ½å·²å¤±æ•ˆ"
              echo "EMERGENCY_REQUIRED=true" >> $GITHUB_OUTPUT
              echo "EMERGENCY_REASON=è¶…è¿‡90åˆ†é’Ÿæœªæ›´æ–°ï¼Œä¸»å¤‡è§¦å‘å™¨å¯èƒ½éƒ½å·²å¤±æ•ˆ" >> $GITHUB_OUTPUT
              echo "TIME_SINCE_LAST=$TIME_DIFF" >> $GITHUB_OUTPUT
            else
              echo "âœ… ç³»ç»Ÿæ­£å¸¸ï¼šè·ç¦»ä¸Šæ¬¡æ›´æ–°ä»…${TIME_DIFF}åˆ†é’Ÿ"
              echo "EMERGENCY_REQUIRED=false" >> $GITHUB_OUTPUT
              echo "EMERGENCY_REASON=ç³»ç»Ÿæ­£å¸¸è¿è¡Œï¼Œæ— éœ€ç´§æ€¥æ¢å¤" >> $GITHUB_OUTPUT
              echo "TIME_SINCE_LAST=$TIME_DIFF" >> $GITHUB_OUTPUT
            fi
          else
            echo "âš ï¸ æ— æ³•è·å–æœ€åæ›´æ–°æ—¶é—´ï¼Œå¯èƒ½éœ€è¦ç´§æ€¥æ¢å¤"
            echo "EMERGENCY_REQUIRED=true" >> $GITHUB_OUTPUT
            echo "EMERGENCY_REASON=æ— æ³•è·å–æœ€åæ›´æ–°æ—¶é—´ï¼Œç³»ç»ŸçŠ¶æ€å¼‚å¸¸" >> $GITHUB_OUTPUT
            echo "TIME_SINCE_LAST=unknown" >> $GITHUB_OUTPUT
          fi
        else
          echo "ğŸš¨ README.mdæ–‡ä»¶ä¸å­˜åœ¨ï¼Œéœ€è¦ç´§æ€¥æ¢å¤ï¼"
          echo "EMERGENCY_REQUIRED=true" >> $GITHUB_OUTPUT
          echo "EMERGENCY_REASON=README.mdæ–‡ä»¶ä¸å­˜åœ¨ï¼Œç³»ç»Ÿä¸¥é‡å¼‚å¸¸" >> $GITHUB_OUTPUT
          echo "TIME_SINCE_LAST=unknown" >> $GITHUB_OUTPUT
        fi
        
        # è®°å½•è§¦å‘æ–¹å¼
        echo "ğŸ¯ è§¦å‘æ–¹å¼: ${{ github.event_name }} (ç´§æ€¥æ¢å¤æ£€æŸ¥)"
        echo "TRIGGER_TYPE=${{ github.event_name }}" >> $GITHUB_OUTPUT
        
    - name: ğŸ“Š ç´§æ€¥çŠ¶æ€æŠ¥å‘Š
      run: |
        echo "## ğŸš¨ ç´§æ€¥æ¢å¤çŠ¶æ€æ£€æŸ¥" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**æ£€æŸ¥æ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S åŒ—äº¬æ—¶é—´')" >> $GITHUB_STEP_SUMMARY
        echo "**è§¦å‘æ–¹å¼**: ${{ steps.emergency_check.outputs.TRIGGER_TYPE }}" >> $GITHUB_STEP_SUMMARY
        echo "**è·ç¦»ä¸Šæ¬¡æ›´æ–°**: ${{ steps.emergency_check.outputs.TIME_SINCE_LAST }} åˆ†é’Ÿ" >> $GITHUB_STEP_SUMMARY
        echo "**æ˜¯å¦éœ€è¦ç´§æ€¥æ¢å¤**: ${{ steps.emergency_check.outputs.EMERGENCY_REQUIRED }}" >> $GITHUB_STEP_SUMMARY
        echo "**æ£€æŸ¥ç»“æœ**: ${{ steps.emergency_check.outputs.EMERGENCY_REASON }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.emergency_check.outputs.EMERGENCY_REQUIRED }}" = "true" ]; then
          echo "ğŸš¨ **éœ€è¦ç«‹å³æ‰§è¡Œç´§æ€¥æ¢å¤ï¼**" >> $GITHUB_STEP_SUMMARY
        else
          echo "âœ… **ç³»ç»Ÿè¿è¡Œæ­£å¸¸ï¼Œæ— éœ€ç´§æ€¥æ¢å¤**" >> $GITHUB_STEP_SUMMARY
        fi

    - name: ğŸš¨ è§¦å‘ç´§æ€¥æ¢å¤
      if: steps.emergency_check.outputs.EMERGENCY_REQUIRED == 'true'
      run: |
        echo "ğŸš¨ å¼€å§‹æ‰§è¡Œç´§æ€¥æ¢å¤æµç¨‹..."
        
        # è®°å½•ç´§æ€¥æ¢å¤äº‹ä»¶
        echo "## ğŸš¨ ç´§æ€¥æ¢å¤äº‹ä»¶è®°å½•" >> emergency_recovery.log
        echo "- æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')" >> emergency_recovery.log
        echo "- åŸå› : ${{ steps.emergency_check.outputs.EMERGENCY_REASON }}" >> emergency_recovery.log
        echo "- è·ç¦»ä¸Šæ¬¡æ›´æ–°: ${{ steps.emergency_check.outputs.TIME_SINCE_LAST }} åˆ†é’Ÿ" >> emergency_recovery.log
        echo "- è§¦å‘æ–¹å¼: ${{ steps.emergency_check.outputs.TRIGGER_TYPE }}" >> emergency_recovery.log
        echo "---" >> emergency_recovery.log
        
        # ä½¿ç”¨GitHub APIè§¦å‘ä¸»å·¥ä½œæµ
        echo "ğŸ”§ æ­£åœ¨é€šè¿‡APIè§¦å‘ä¸»åŒæ­¥å·¥ä½œæµ..."
        
        curl -X POST \
          -H "Accept: application/vnd.github.v3+json" \
          -H "Authorization: token ${{ github.token }}" \
          -H "X-GitHub-Api-Version: 2022-11-28" \
          https://api.github.com/repos/${{ github.repository }}/actions/workflows/sync-gist.yml/dispatches \
          -d '{"ref":"main","inputs":{"emergency_trigger":"true"}}'
        
        if [ $? -eq 0 ]; then
          echo "âœ… ä¸»å·¥ä½œæµè§¦å‘æˆåŠŸ"
          echo "MAIN_TRIGGER_SUCCESS=true" >> $GITHUB_OUTPUT
        else
          echo "âŒ ä¸»å·¥ä½œæµè§¦å‘å¤±è´¥ï¼Œå°è¯•è§¦å‘å¤‡ç”¨å·¥ä½œæµ"
          echo "MAIN_TRIGGER_SUCCESS=false" >> $GITHUB_OUTPUT
          
          # å¦‚æœä¸»å·¥ä½œæµè§¦å‘å¤±è´¥ï¼Œå°è¯•è§¦å‘å¤‡ç”¨å·¥ä½œæµ
          curl -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token ${{ github.token }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/${{ github.repository }}/actions/workflows/sync-gist-backup.yml/dispatches \
            -d '{"ref":"main","inputs":{"emergency_trigger":"true"}}'
          
          if [ $? -eq 0 ]; then
            echo "âœ… å¤‡ç”¨å·¥ä½œæµè§¦å‘æˆåŠŸ"
            echo "BACKUP_TRIGGER_SUCCESS=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ å¤‡ç”¨å·¥ä½œæµè§¦å‘ä¹Ÿå¤±è´¥"
            echo "BACKUP_TRIGGER_SUCCESS=false" >> $GITHUB_OUTPUT
          fi
        fi
        
    - name: ğŸ”§ ç›´æ¥æ‰§è¡Œç´§æ€¥åŒæ­¥
      if: steps.emergency_check.outputs.EMERGENCY_REQUIRED == 'true'
      run: |
        echo "ğŸ”§ å¦‚æœAPIè§¦å‘å¤±è´¥ï¼Œç›´æ¥æ‰§è¡Œç´§æ€¥åŒæ­¥..."
        
        # åˆ›å»ºnodesç›®å½•
        mkdir -p nodes
        
        # ä¸‹è½½æ–‡ä»¶
        GIST_BASE_URL="https://gist.githubusercontent.com/shuaidaoya/9e5cf2749c0ce79932dd9229d9b4162b/raw"
        
        echo "ğŸ“¥ ç´§æ€¥ä¸‹è½½ all.yaml..."
        curl -fsSL "${GIST_BASE_URL}/all.yaml" -o nodes/all.yaml || echo "âŒ all.yaml ä¸‹è½½å¤±è´¥"
        
        echo "ğŸ“¥ ç´§æ€¥ä¸‹è½½ base64.txt..."
        curl -fsSL "${GIST_BASE_URL}/base64.txt" -o nodes/base64.txt || echo "âŒ base64.txt ä¸‹è½½å¤±è´¥"
        
        echo "ğŸ“¥ ç´§æ€¥ä¸‹è½½ history.yaml..."
        curl -fsSL "${GIST_BASE_URL}/history.yaml" -o nodes/history.yaml || echo "âŒ history.yaml ä¸‹è½½å¤±è´¥"
        
        echo "ğŸ“¥ ç´§æ€¥ä¸‹è½½ mihomo.yaml..."
        curl -fsSL "${GIST_BASE_URL}/mihomo.yaml" -o nodes/mihomo.yaml || echo "âŒ mihomo.yaml ä¸‹è½½å¤±è´¥"
        
        # ç»Ÿè®¡èŠ‚ç‚¹
        yaml_nodes=0
        base64_lines=0
        
        if [ -f "nodes/all.yaml" ] && [ -s "nodes/all.yaml" ]; then
          yaml_nodes=$(grep -c "server:" nodes/all.yaml 2>/dev/null || echo "0")
        fi
        
        if [ -f "nodes/base64.txt" ] && [ -s "nodes/base64.txt" ]; then
          decoded_content=$(base64 -d nodes/base64.txt 2>/dev/null)
          if [ $? -eq 0 ] && [ -n "$decoded_content" ]; then
            base64_lines=$(echo "$decoded_content" | grep -c "^[a-zA-Z0-9]*://" 2>/dev/null || echo "0")
          fi
        fi
        
        echo "ğŸ“Š ç´§æ€¥ç»Ÿè®¡: YAML: $yaml_nodes ä¸ª, Base64: $base64_lines ä¸ª"
        
        # æ›´æ–°README
        current_date=$(date '+%Y-%m-%d %H:%M:%S')
        current_utc=$(date '+%Y-%m-%d %H:%M:%S åŒ—äº¬æ—¶é—´')
        
        if [ -f "README.md" ]; then
          # æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
          sed -i '/<!-- AUTO_STATS_START -->/,/<!-- AUTO_STATS_END -->/{
            s/| ğŸ• \*\*æœ€åæ›´æ–°æ—¶é—´\*\* | .* |/| ğŸ• **æœ€åæ›´æ–°æ—¶é—´** | '"$current_utc"' |/
            s/| ğŸ“„ \*\*YAML èŠ‚ç‚¹\*\* | .* |/| ğŸ“„ **YAML èŠ‚ç‚¹** | '"$yaml_nodes"' ä¸ª |/
            s/| ğŸ“ \*\*Base64 èŠ‚ç‚¹æ•°\*\* | .* |/| ğŸ“ **Base64 èŠ‚ç‚¹æ•°** | '"$base64_lines"' ä¸ª |/
            s/| ğŸ”„ \*\*åŒæ­¥çŠ¶æ€\*\* | .* |/| ğŸ”„ **åŒæ­¥çŠ¶æ€** | ğŸš¨ ç´§æ€¥æ¢å¤ |/
          }' README.md
          
          # æ·»åŠ ç´§æ€¥æ¢å¤è®°å½•
          node_details="ğŸš¨ ç´§æ€¥æ¢å¤æ›´æ–° - YAML:${yaml_nodes}ä¸ª, Base64:${base64_lines}ä¸ª"
          node_summary="YAML:${yaml_nodes}ä¸ª, Base64:${base64_lines}ä¸ª"
          
          sed -i '/|------|------|----------|/a\| '"$current_date"' | '"$node_summary"' | '"$node_details"' |' README.md
          
          echo "âœ… README.md ç´§æ€¥æ›´æ–°å®Œæˆ"
        fi
        
    - name: ğŸ’¾ æäº¤ç´§æ€¥æ¢å¤ç»“æœ
      if: steps.emergency_check.outputs.EMERGENCY_REQUIRED == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action (Emergency)"
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
        if [ -n "$(git status --porcelain)" ]; then
          git add .
          git commit -m "ğŸš¨ ç´§æ€¥æ¢å¤æ›´æ–° - $(date '+%Y-%m-%d %H:%M:%S') - ä¸»å¤‡è§¦å‘å™¨å¤±æ•ˆ"
          git push
          echo "âœ… ç´§æ€¥æ¢å¤å®Œæˆå¹¶æ¨é€åˆ°ä»“åº“"
        else
          echo "â„¹ï¸ æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´"
        fi
      env:
        GITHUB_TOKEN: ${{ github.token }}
        
    - name: ğŸ“‹ ç´§æ€¥æ¢å¤æ€»ç»“
      run: |
        echo "## ğŸš¨ ç´§æ€¥æ¢å¤æ‰§è¡Œç»“æœ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**æ‰§è¡Œæ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S åŒ—äº¬æ—¶é—´')" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.emergency_check.outputs.EMERGENCY_REQUIRED }}" = "true" ]; then
          echo "**æ¢å¤çŠ¶æ€**: ğŸš¨ å·²æ‰§è¡Œç´§æ€¥æ¢å¤" >> $GITHUB_STEP_SUMMARY
          echo "**æ¢å¤åŸå› **: ${{ steps.emergency_check.outputs.EMERGENCY_REASON }}" >> $GITHUB_STEP_SUMMARY
          echo "**è·ç¦»ä¸Šæ¬¡æ›´æ–°**: ${{ steps.emergency_check.outputs.TIME_SINCE_LAST }} åˆ†é’Ÿ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ”§ æ¢å¤æªæ–½" >> $GITHUB_STEP_SUMMARY
          echo "1. âœ… é€šè¿‡APIè§¦å‘ä¸»å·¥ä½œæµ" >> $GITHUB_STEP_SUMMARY
          echo "2. âœ… é€šè¿‡APIè§¦å‘å¤‡ç”¨å·¥ä½œæµ" >> $GITHUB_STEP_SUMMARY
          echo "3. âœ… ç›´æ¥æ‰§è¡Œç´§æ€¥åŒæ­¥" >> $GITHUB_STEP_SUMMARY
          echo "4. âœ… æ›´æ–°READMEçŠ¶æ€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ‰ **ç´§æ€¥æ¢å¤å®Œæˆï¼ç³»ç»Ÿå·²æ¢å¤æ­£å¸¸è¿è¡Œ**" >> $GITHUB_STEP_SUMMARY
        else
          echo "**æ£€æŸ¥ç»“æœ**: âœ… ç³»ç»Ÿè¿è¡Œæ­£å¸¸" >> $GITHUB_STEP_SUMMARY
          echo "**è·ç¦»ä¸Šæ¬¡æ›´æ–°**: ${{ steps.emergency_check.outputs.TIME_SINCE_LAST }} åˆ†é’Ÿ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ’š **æ— éœ€ç´§æ€¥æ¢å¤ï¼Œç³»ç»Ÿè¿è¡Œæ­£å¸¸**" >> $GITHUB_STEP_SUMMARY
        fi