name: üîÑ ÂêåÊ≠• Gist ËäÇÁÇπÊñá‰ª∂

on:
  schedule:
    # ÊØè30ÂàÜÈíüÊâßË°å‰∏ÄÊ¨° (Áªü‰∏ÄÈó¥ÈöîÔºåÈÅøÂÖçËΩÆÊç¢)
    - cron: '*/30 * * * *'
  workflow_dispatch:
    inputs:
      dry_run:
        description: ÊºîÁªÉÊ®°ÂºèÔºà‰∏çÊèê‰∫§‰∏çÊé®ÈÄÅÔºâ
        type: boolean
        default: false
      force:
        description: Âº∫Âà∂ÊâßË°åÔºàÂøΩÁï•ÂÅ•Â∫∑Ê£ÄÊü•Ôºâ
        type: boolean
        default: false

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

# ËÆæÁΩÆÊùÉÈôê
permissions:
  contents: write
  actions: read

jobs:
  health:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      TZ: Asia/Shanghai
    outputs:
      SKIP_EXECUTION: ${{ steps.check.outputs.SKIP_EXECUTION }}
      FORCE_UPDATE: ${{ steps.check.outputs.FORCE_UPDATE }}
      TRIGGER_TYPE: ${{ steps.check.outputs.TRIGGER_TYPE }}
      EXECUTION_REASON: ${{ steps.check.outputs.EXECUTION_REASON }}
    steps:
    - name:  ÂÅ•Â∫∑Ê£ÄÊü• - ÈÅøÂÖçÈáçÂ§çÊâßË°å
      id: check
      run: |
        echo "üîç ÂºÄÂßãÊâßË°åÂÅ•Â∫∑Ê£ÄÊü•..."
        
        # Ëé∑ÂèñÊúÄÂêéÊõ¥Êñ∞Êó∂Èó¥
        if [ -f "README.md" ]; then
          LAST_UPDATE=$(grep -o '[0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\} [0-9]\{2\}:[0-9]\{2\}:[0-9]\{2\}' README.md | tail -1)
          if [ -n "$LAST_UPDATE" ]; then
            echo "üìÖ ÊúÄÂêéÊõ¥Êñ∞Êó∂Èó¥: $LAST_UPDATE"
            
            # ËÆ°ÁÆóÊó∂Èó¥Â∑ÆÔºàÂàÜÈíüÔºâ
            CURRENT_TIME=$(date '+%Y-%m-%d %H:%M:%S')
            LAST_TIMESTAMP=$(date -d "$LAST_UPDATE" +%s 2>/dev/null || echo "0")
            CURRENT_TIMESTAMP=$(date -d "$CURRENT_TIME" +%s)
            TIME_DIFF=$(( (CURRENT_TIMESTAMP - LAST_TIMESTAMP) / 60 ))
            
            echo "‚è∞ ÂΩìÂâçÊó∂Èó¥: $CURRENT_TIME"
            echo "‚è±Ô∏è Êó∂Èó¥Èó¥Èöî: $TIME_DIFF ÂàÜÈíü"
            
            # Âà§Êñ≠ÊâßË°åÁ≠ñÁï•
            if [ "$TIME_DIFF" -lt 30 ]; then
              echo "‚úÖ Ë∑ùÁ¶ª‰∏äÊ¨°Êõ¥Êñ∞‰∏çË∂≥30ÂàÜÈíüÔºåË∑≥ËøáÊú¨Ê¨°ÊâßË°å"
              echo "SKIP_EXECUTION=true" >> $GITHUB_OUTPUT
              echo "EXECUTION_REASON=Ë∑ùÁ¶ª‰∏äÊ¨°Êõ¥Êñ∞‰ªÖ${TIME_DIFF}ÂàÜÈíü" >> $GITHUB_OUTPUT
            elif [ "$TIME_DIFF" -gt 120 ]; then
              echo "‚ö†Ô∏è Ë∑ùÁ¶ª‰∏äÊ¨°Êõ¥Êñ∞Ë∂ÖËøá2Â∞èÊó∂ÔºåÂº∫Âà∂ÊâßË°åÊõ¥Êñ∞"
              echo "SKIP_EXECUTION=false" >> $GITHUB_OUTPUT
              echo "FORCE_UPDATE=true" >> $GITHUB_OUTPUT
              echo "EXECUTION_REASON=Ë∂ÖËøá2Â∞èÊó∂Êú™Êõ¥Êñ∞ÔºåÂº∫Âà∂ÊâßË°å" >> $GITHUB_OUTPUT
            else
              echo "‚úÖ Ê≠£Â∏∏ÊâßË°åÈó¥ÈöîÔºåÁªßÁª≠Êõ¥Êñ∞"
              echo "SKIP_EXECUTION=false" >> $GITHUB_OUTPUT
              echo "FORCE_UPDATE=false" >> $GITHUB_OUTPUT
              echo "EXECUTION_REASON=Ê≠£Â∏∏ÊâßË°åÈó¥Èöî(${TIME_DIFF}ÂàÜÈíü)" >> $GITHUB_OUTPUT
            fi
          else
            echo "‚ö†Ô∏è Êó†Ê≥ïËé∑ÂèñÊúÄÂêéÊõ¥Êñ∞Êó∂Èó¥ÔºåÊâßË°åÊõ¥Êñ∞"
            echo "SKIP_EXECUTION=false" >> $GITHUB_OUTPUT
            echo "FORCE_UPDATE=true" >> $GITHUB_OUTPUT
            echo "EXECUTION_REASON=Êó†Ê≥ïËé∑ÂèñÊõ¥Êñ∞Êó∂Èó¥ÔºåÂº∫Âà∂ÊâßË°å" >> $GITHUB_OUTPUT
          fi
        else
          echo "‚ö†Ô∏è README.md‰∏çÂ≠òÂú®ÔºåÊâßË°åÂàùÂßãÂåñÊõ¥Êñ∞"
          echo "SKIP_EXECUTION=false" >> $GITHUB_OUTPUT
          echo "FORCE_UPDATE=true" >> $GITHUB_OUTPUT
          echo "EXECUTION_REASON=README.md‰∏çÂ≠òÂú®ÔºåÂàùÂßãÂåñÊâßË°å" >> $GITHUB_OUTPUT
        fi
        
        # ËÆ∞ÂΩïËß¶ÂèëÊñπÂºè
        echo "üéØ Ëß¶ÂèëÊñπÂºè: ${{ github.event_name }}"
        echo "TRIGGER_TYPE=${{ github.event_name }}" >> $GITHUB_OUTPUT
        
    - name: üìä ÊâßË°åÁä∂ÊÄÅÊä•Âëä
      run: |
        echo "## üîç ÊâßË°åÁä∂ÊÄÅÊ£ÄÊü•" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Ëß¶ÂèëÊñπÂºè**: ${{ steps.check.outputs.TRIGGER_TYPE }}" >> $GITHUB_STEP_SUMMARY
        echo "**ÊâßË°åÂéüÂõ†**: ${{ steps.check.outputs.EXECUTION_REASON }}" >> $GITHUB_STEP_SUMMARY
        echo "**ÊòØÂê¶Ë∑≥Ëøá**: ${{ steps.check.outputs.SKIP_EXECUTION }}" >> $GITHUB_STEP_SUMMARY
        echo "**Âº∫Âà∂Êõ¥Êñ∞**: ${{ steps.check.outputs.FORCE_UPDATE }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.check.outputs.SKIP_EXECUTION }}" = "true" ]; then
          echo "‚è≠Ô∏è **Êú¨Ê¨°ÊâßË°åÂ∞ÜË¢´Ë∑≥Ëøá**" >> $GITHUB_STEP_SUMMARY
        else
          echo "‚ñ∂Ô∏è **ÁªßÁª≠ÊâßË°åÊõ¥Êñ∞ÊµÅÁ®ã**" >> $GITHUB_STEP_SUMMARY
        fi
  run-core:
    needs: health
    if: inputs.force == true || needs.health.outputs.SKIP_EXECUTION != 'true'
    uses: ./.github/workflows/sync-core.yml
    with:
      label: ‰∏ªÂêåÊ≠•
      dry_run: ${{ inputs.dry_run }}
