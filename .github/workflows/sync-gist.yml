name: Sync Gist Files

on:
  schedule:
    # æ¯éš”15åˆ†é’Ÿè¿è¡Œä¸€æ¬¡ (é«˜é¢‘æ›´æ–°æ¨¡å¼)
    - cron: '*/15 * * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/sync-gist.yml'

jobs:
  sync-gist:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Create nodes directory
      run: |
        mkdir -p nodes
        
    - name: Download Gist files
      run: |
        # Gist åŸºç¡€URL
        GIST_BASE_URL="https://gist.githubusercontent.com/shuaidaoya/9e5cf2749c0ce79932dd9229d9b4162b/raw/45a4616a347cf5998fd9ef83d41d8a91ff314bc6"
        
        # ä¸‹è½½å„ç§æ ¼å¼çš„è®¢é˜…æ–‡ä»¶
        echo "ðŸ“¥ æ­£åœ¨ä¸‹è½½ all.yaml..."
        curl -fsSL "${GIST_BASE_URL}/all.yaml" -o nodes/all.yaml || echo "âŒ all.yaml ä¸‹è½½å¤±è´¥"
        
        echo "ðŸ“¥ æ­£åœ¨ä¸‹è½½ base64.txt..."
        curl -fsSL "${GIST_BASE_URL}/base64.txt" -o nodes/base64.txt || echo "âŒ base64.txt ä¸‹è½½å¤±è´¥"
        
        echo "ðŸ“¥ æ­£åœ¨ä¸‹è½½ history.yaml..."
        curl -fsSL "${GIST_BASE_URL}/history.yaml" -o nodes/history.yaml || echo "âŒ history.yaml ä¸‹è½½å¤±è´¥"
        
        echo "ðŸ“¥ æ­£åœ¨ä¸‹è½½ mihomo.yaml..."
        curl -fsSL "${GIST_BASE_URL}/mihomo.yaml" -o nodes/mihomo.yaml || echo "âŒ mihomo.yaml ä¸‹è½½å¤±è´¥"
        
    - name: Generate file info
      run: |
        # ç”Ÿæˆæ–‡ä»¶ä¿¡æ¯
        echo "# ðŸ“Š èŠ‚ç‚¹æ–‡ä»¶ä¿¡æ¯" > nodes/README.md
        echo "" >> nodes/README.md
        echo "**æ›´æ–°æ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> nodes/README.md
        echo "" >> nodes/README.md
        echo "| æ–‡ä»¶å | å¤§å° | æœ€åŽä¿®æ”¹ |" >> nodes/README.md
        echo "|--------|------|----------|" >> nodes/README.md
        
        for file in nodes/*.yaml nodes/*.txt; do
          if [ -f "$file" ]; then
            filename=$(basename "$file")
            filesize=$(ls -lh "$file" | awk '{print $5}')
            modified=$(date -r "$file" '+%Y-%m-%d %H:%M')
            echo "| $filename | $filesize | $modified |" >> nodes/README.md
          fi
        done
        
        echo "" >> nodes/README.md
        echo "> ðŸ”„ æ–‡ä»¶æ¯15åˆ†é’Ÿè‡ªåŠ¨æ›´æ–°ï¼Œç¡®ä¿èŠ‚ç‚¹çš„æ–°é²œåº¦å’Œå¯ç”¨æ€§" >> nodes/README.md
        
    - name: Count nodes
      id: count
      run: |
        # ç»Ÿè®¡èŠ‚ç‚¹æ•°é‡
        total_nodes=0
        
        if [ -f "nodes/all.yaml" ]; then
          yaml_nodes=$(grep -c "server:" nodes/all.yaml 2>/dev/null || echo "0")
          total_nodes=$((total_nodes + yaml_nodes))
          echo "yaml_nodes=$yaml_nodes" >> $GITHUB_OUTPUT
        fi
        
        if [ -f "nodes/base64.txt" ]; then
          base64_lines=$(wc -l < nodes/base64.txt 2>/dev/null || echo "0")
          echo "base64_lines=$base64_lines" >> $GITHUB_OUTPUT
        fi
        
        echo "total_nodes=$total_nodes" >> $GITHUB_OUTPUT
        echo "ðŸ“Š ç»Ÿè®¡åˆ° $total_nodes ä¸ªèŠ‚ç‚¹"
        
    - name: Update main README
      run: |
        # æ›´æ–°ä¸»READMEä¸­çš„ç»Ÿè®¡ä¿¡æ¯
        current_date=$(date '+%Y-%m-%d %H:%M')
        total_nodes="${{ steps.count.outputs.total_nodes }}"
        
        # åˆ›å»ºä¸´æ—¶æ–‡ä»¶æ¥æ›´æ–°README
        if [ -f "README.md" ]; then
          # æŸ¥æ‰¾å¹¶æ›´æ–°æ›´æ–°æ—¥å¿—è¡¨æ ¼ä¸­çš„ç¬¬ä¸€è¡Œæ•°æ®
          sed -i "s/| [0-9-]* [0-9:]* | [^|]* | [^|]* |/| $current_date | ${total_nodes}ä¸ªèŠ‚ç‚¹ | ðŸ“Š è‡ªåŠ¨æ›´æ–° |/" README.md
          echo "âœ… README.md ç»Ÿè®¡ä¿¡æ¯å·²æ›´æ–°"
        fi
        
    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
        if [ -n "$(git status --porcelain)" ]; then
          git add .
          git commit -m "ðŸ”„ è‡ªåŠ¨æ›´æ–°èŠ‚ç‚¹æ–‡ä»¶ - $(date '+%Y-%m-%d %H:%M:%S')"
          git push
          echo "âœ… æ–‡ä»¶å·²æ›´æ–°å¹¶æŽ¨é€åˆ°ä»“åº“"
        else
          echo "â„¹ï¸ æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´"
        fi
        
    - name: Create release summary
      run: |
        echo "## ðŸ“Š åŒæ­¥ç»“æžœ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**åŒæ­¥æ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "**èŠ‚ç‚¹æ€»æ•°**: ${{ steps.count.outputs.total_nodes }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“ æ–‡ä»¶çŠ¶æ€" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        for file in nodes/*.yaml nodes/*.txt; do
          if [ -f "$file" ]; then
            filename=$(basename "$file")
            filesize=$(ls -lh "$file" | awk '{print $5}')
            echo "- âœ… **$filename**: $filesize" >> $GITHUB_STEP_SUMMARY
          fi
        done
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸŽ‰ **åŒæ­¥å®Œæˆï¼æ‰€æœ‰æ–‡ä»¶å·²æˆåŠŸæ›´æ–°åˆ°ä»“åº“**" >> $GITHUB_STEP_SUMMARY