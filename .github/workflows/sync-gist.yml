name: ğŸ”„ åŒæ­¥ Gist èŠ‚ç‚¹æ–‡ä»¶

on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:
    inputs:
      dry_run:
        description: æ¼”ç»ƒæ¨¡å¼ï¼ˆä¸æäº¤ä¸æ¨é€ï¼‰
        type: boolean
        default: false
      force:
        description: å¼ºåˆ¶æ‰§è¡Œï¼ˆå¿½ç•¥å¥åº·æ£€æŸ¥ï¼‰
        type: boolean
        default: false

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write
  actions: read
  issues: write

jobs:
  health:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      TZ: Asia/Shanghai
    steps:
      - name: ğŸ“¦ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ github.token }}
          persist-credentials: true

      - name: ğŸ” æ£€æŸ¥ Gist æ˜¯å¦æ›´æ–°
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const gistId = '9e5cf2749c0ce79932dd9229d9b4162b';
            let stored = '';
            if (fs.existsSync('README.md')) {
              const text = fs.readFileSync('README.md', 'utf8');
              const m = text.match(/<!--\s*GIST_UPDATED_AT:\s*([^\s]+)\s*-->/);
              if (m) stored = m[1];
            }
            const { data } = await github.rest.gists.get({ gist_id: gistId });
            const updatedAt = data.updated_at || '';
            const shouldRun = !stored || stored !== updatedAt;
            core.setOutput('trigger_type', context.eventName);
            core.setOutput('gist_updated_at', updatedAt);
            core.setOutput('stored_gist_updated_at', stored);
            core.setOutput('should_run', shouldRun ? 'true' : 'false');
            core.setOutput('execution_reason', shouldRun ? (stored ? 'Gist å·²æ›´æ–°' : 'é¦–æ¬¡æ‰§è¡Œï¼Œæœªè®°å½• Gist ç‰ˆæœ¬') : 'Gist æœªæ›´æ–°ï¼Œè·³è¿‡åŒæ­¥');

      - name: ğŸ“Š æ‰§è¡ŒçŠ¶æ€æŠ¥å‘Š
        run: |
          echo "## ğŸ” æ‰§è¡ŒçŠ¶æ€æ£€æŸ¥" >> $GITHUB_STEP_SUMMARY
          echo "**è§¦å‘æ–¹å¼**: ${{ steps.check.outputs.trigger_type }}" >> $GITHUB_STEP_SUMMARY
          echo "**æ‰§è¡ŒåŸå› **: ${{ steps.check.outputs.execution_reason }}" >> $GITHUB_STEP_SUMMARY
          echo "**Gist æœ€è¿‘æ›´æ–°æ—¶é—´**: ${{ steps.check.outputs.gist_updated_at }}" >> $GITHUB_STEP_SUMMARY
          echo "**ä¸Šæ¬¡è®°å½•çš„ Gist ç‰ˆæœ¬**: ${{ steps.check.outputs.stored_gist_updated_at }}" >> $GITHUB_STEP_SUMMARY
          echo "**æ˜¯å¦éœ€è¦æ‰§è¡Œ**: ${{ steps.check.outputs.should_run }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check.outputs.should_run }}" = "false" ]; then
            echo "â­ï¸ æœ¬æ¬¡æ‰§è¡Œå°†è¢«è·³è¿‡" >> $GITHUB_STEP_SUMMARY
          else
            echo "â–¶ï¸ ç»§ç»­æ‰§è¡Œæ›´æ–°æµç¨‹" >> $GITHUB_STEP_SUMMARY
          fi
    outputs:
      TRIGGER_TYPE: ${{ steps.check.outputs.trigger_type }}
      GIST_UPDATED_AT: ${{ steps.check.outputs.gist_updated_at }}
      STORED_GIST_UPDATED_AT: ${{ steps.check.outputs.stored_gist_updated_at }}
      SHOULD_RUN: ${{ steps.check.outputs.should_run }}
      EXECUTION_REASON: ${{ steps.check.outputs.execution_reason }}

  run-core:
    needs: health
    if: inputs.force == true || needs.health.outputs.SHOULD_RUN == 'true'
    uses: ./.github/workflows/sync-core.yml
    with:
      label: ä¸»åŒæ­¥
      gist_updated_at: ${{ needs.health.outputs.GIST_UPDATED_AT }}
      dry_run: ${{ inputs.dry_run || false }}
