name: ğŸ”„ åŒæ­¥ Gist èŠ‚ç‚¹æ–‡ä»¶

on:
  schedule:
    # æ¯éš”30åˆ†é’Ÿè¿è¡Œä¸€æ¬¡ (é«˜é¢‘æ›´æ–°æ¨¡å¼)
    - cron: '*/30 * * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main ]
    paths: [ '.github/workflows/sync-gist.yml' ]

# è®¾ç½®æƒé™
permissions:
  contents: write
  actions: read

jobs:
  sync-gist:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¦ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        token: ${{ github.token }}
        fetch-depth: 0
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Create nodes directory
      run: |
        mkdir -p nodes
        
    - name: Download Gist files
      run: |
        # Gist åŸºç¡€URL (ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬ï¼Œä¸å›ºå®šcommit hash)
        GIST_BASE_URL="https://gist.githubusercontent.com/shuaidaoya/9e5cf2749c0ce79932dd9229d9b4162b/raw"
        
        # ä¸‹è½½å„ç§æ ¼å¼çš„è®¢é˜…æ–‡ä»¶
        echo "ğŸ“¥ æ­£åœ¨ä¸‹è½½ all.yaml..."
        curl -fsSL "${GIST_BASE_URL}/all.yaml" -o nodes/all.yaml || echo "âŒ all.yaml ä¸‹è½½å¤±è´¥"
        
        echo "ğŸ“¥ æ­£åœ¨ä¸‹è½½ base64.txt..."
        curl -fsSL "${GIST_BASE_URL}/base64.txt" -o nodes/base64.txt || echo "âŒ base64.txt ä¸‹è½½å¤±è´¥"
        
        echo "ğŸ“¥ æ­£åœ¨ä¸‹è½½ history.yaml..."
        curl -fsSL "${GIST_BASE_URL}/history.yaml" -o nodes/history.yaml || echo "âŒ history.yaml ä¸‹è½½å¤±è´¥"
        
        echo "ğŸ“¥ æ­£åœ¨ä¸‹è½½ mihomo.yaml..."
        curl -fsSL "${GIST_BASE_URL}/mihomo.yaml" -o nodes/mihomo.yaml || echo "âŒ mihomo.yaml ä¸‹è½½å¤±è´¥"
        
    - name: Generate file info
      run: |
        # ç”Ÿæˆæ–‡ä»¶ä¿¡æ¯
        echo "# ğŸ“Š èŠ‚ç‚¹æ–‡ä»¶ä¿¡æ¯" > nodes/README.md
        echo "" >> nodes/README.md
        echo "**æ›´æ–°æ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> nodes/README.md
        echo "" >> nodes/README.md
        echo "| æ–‡ä»¶å | å¤§å° | æœ€åä¿®æ”¹ |" >> nodes/README.md
        echo "|--------|------|----------|" >> nodes/README.md
        
        for file in nodes/*.yaml nodes/*.txt; do
          if [ -f "$file" ]; then
            filename=$(basename "$file")
            filesize=$(ls -lh "$file" | awk '{print $5}')
            modified=$(date -r "$file" '+%Y-%m-%d %H:%M')
            echo "| $filename | $filesize | $modified |" >> nodes/README.md
          fi
        done
        
        echo "" >> nodes/README.md
        echo "> ğŸ”„ æ–‡ä»¶æ¯30åˆ†é’Ÿè‡ªåŠ¨æ›´æ–°ï¼Œç¡®ä¿èŠ‚ç‚¹çš„æ–°é²œåº¦å’Œå¯ç”¨æ€§" >> nodes/README.md
        
    - name: Count nodes
      id: count
      run: |
        # ç»Ÿè®¡èŠ‚ç‚¹æ•°é‡ - å¢å¼ºé”™è¯¯å¤„ç†
        yaml_nodes=0
        base64_lines=0
        
        echo "ğŸ” å¼€å§‹ç»Ÿè®¡èŠ‚ç‚¹æ•°é‡..."
        
        # ç»Ÿè®¡YAMLèŠ‚ç‚¹
        if [ -f "nodes/all.yaml" ]; then
          if [ -s "nodes/all.yaml" ]; then
            yaml_nodes=$(grep -c "server:" nodes/all.yaml 2>/dev/null || echo "0")
            # éªŒè¯YAMLç»Ÿè®¡ç»“æœ
            if ! [[ "$yaml_nodes" =~ ^[0-9]+$ ]]; then
              echo "âš ï¸ YAMLèŠ‚ç‚¹ç»Ÿè®¡å¼‚å¸¸ï¼Œé‡ç½®ä¸º0"
              yaml_nodes=0
            fi
            echo "âœ… YAMLèŠ‚ç‚¹ç»Ÿè®¡: $yaml_nodes ä¸ª"
          else
            echo "âš ï¸ all.yaml æ–‡ä»¶ä¸ºç©º"
            yaml_nodes=0
          fi
          echo "yaml_nodes=$yaml_nodes" >> $GITHUB_OUTPUT
        else
          echo "âš ï¸ all.yaml æ–‡ä»¶ä¸å­˜åœ¨"
          yaml_nodes=0
          echo "yaml_nodes=0" >> $GITHUB_OUTPUT
        fi
        
        # ç»Ÿè®¡Base64èŠ‚ç‚¹
        if [ -f "nodes/base64.txt" ]; then
          if [ -s "nodes/base64.txt" ]; then
            # å°è¯•è§£ç å¹¶ç»Ÿè®¡ï¼Œå¢åŠ é”™è¯¯å¤„ç†
            echo "ğŸ” æ­£åœ¨è§£ç base64.txtæ–‡ä»¶..."
            decoded_content=$(base64 -d nodes/base64.txt 2>/dev/null)
            if [ $? -eq 0 ] && [ -n "$decoded_content" ]; then
              base64_lines=$(echo "$decoded_content" | grep -c "^[a-zA-Z0-9]*://" 2>/dev/null || echo "0")
              # éªŒè¯Base64ç»Ÿè®¡ç»“æœ
              if ! [[ "$base64_lines" =~ ^[0-9]+$ ]]; then
                echo "âš ï¸ Base64èŠ‚ç‚¹ç»Ÿè®¡å¼‚å¸¸ï¼Œé‡ç½®ä¸º0"
                base64_lines=0
              fi
              echo "âœ… Base64è§£ç åç»Ÿè®¡: $base64_lines ä¸ªèŠ‚ç‚¹"
            else
              echo "âŒ Base64è§£ç å¤±è´¥ï¼Œå¯èƒ½æ–‡ä»¶æŸå"
              base64_lines=0
            fi
          else
            echo "âš ï¸ base64.txt æ–‡ä»¶ä¸ºç©º"
            base64_lines=0
          fi
          echo "base64_lines=$base64_lines" >> $GITHUB_OUTPUT
        else
          echo "âš ï¸ base64.txt æ–‡ä»¶ä¸å­˜åœ¨"
          base64_lines=0
          echo "base64_lines=0" >> $GITHUB_OUTPUT
        fi
        
        echo "ğŸ“Š èŠ‚ç‚¹ç»Ÿè®¡å®Œæˆ: YAML: $yaml_nodes ä¸ª, Base64: $base64_lines ä¸ª"
        
        # ç»Ÿè®¡éªŒè¯
        if [ "$yaml_nodes" -eq 0 ] && [ "$base64_lines" -eq 0 ]; then
          echo "âš ï¸ è­¦å‘Š: æœªç»Ÿè®¡åˆ°ä»»ä½•èŠ‚ç‚¹ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶å†…å®¹"
        fi
        
    - name: Update main README
      run: |
        # æ›´æ–°ä¸»READMEä¸­çš„ç»Ÿè®¡ä¿¡æ¯ - å¢å¼ºé”™è¯¯å¤„ç†
        current_date=$(date '+%Y-%m-%d %H:%M:%S')
        current_utc=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
        yaml_nodes="${{ steps.count.outputs.yaml_nodes }}"
        base64_lines="${{ steps.count.outputs.base64_lines }}"
        
        echo "ğŸ” å¼€å§‹æ›´æ–°README.md..."
        echo "ğŸ“Š ç»Ÿè®¡æ•°æ®: YAML=$yaml_nodes, Base64=$base64_lines"
        
        # éªŒè¯è¾“å…¥æ•°æ®
        if ! [[ "$yaml_nodes" =~ ^[0-9]+$ ]]; then
          echo "âš ï¸ YAMLèŠ‚ç‚¹æ•°æ— æ•ˆï¼Œä½¿ç”¨é»˜è®¤å€¼0"
          yaml_nodes=0
        fi
        if ! [[ "$base64_lines" =~ ^[0-9]+$ ]]; then
          echo "âš ï¸ Base64èŠ‚ç‚¹æ•°æ— æ•ˆï¼Œä½¿ç”¨é»˜è®¤å€¼0"
          base64_lines=0
        fi
        
        # æ›´æ–°å®æ—¶ç»Ÿè®¡åŒºåŸŸ
        if [ -f "README.md" ]; then
          # å¤‡ä»½README.md
          cp README.md README.md.backup
          echo "âœ… å·²å¤‡ä»½README.md"
          # ä½¿ç”¨ sed æ›´æ–° AUTO_STATS åŒºåŸŸå†…çš„ç»Ÿè®¡ä¿¡æ¯
          sed -i '/<!-- AUTO_STATS_START -->/,/<!-- AUTO_STATS_END -->/{
            s/| ğŸ• \*\*æœ€åæ›´æ–°æ—¶é—´\*\* | .* |/| ğŸ• **æœ€åæ›´æ–°æ—¶é—´** | '"$current_utc"' |/
            s/| ğŸ“„ \*\*YAML èŠ‚ç‚¹\*\* | .* |/| ğŸ“„ **YAML èŠ‚ç‚¹** | '"$yaml_nodes"' ä¸ª |/
            s/| ğŸ“ \*\*Base64 èŠ‚ç‚¹æ•°\*\* | .* |/| ğŸ“ **Base64 èŠ‚ç‚¹æ•°** | '"$base64_lines"' ä¸ª |/
            s/| ğŸ”„ \*\*åŒæ­¥çŠ¶æ€\*\* | .* |/| ğŸ”„ **åŒæ­¥çŠ¶æ€** | ğŸŸ¢ å·²åŒæ­¥ |/
          }' README.md
          
          # åœ¨æ›´æ–°æ—¥å¿—è¡¨æ ¼ä¸­æ·»åŠ æ–°çš„è‡ªåŠ¨åŒæ­¥è®°å½•
          # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ä»Šå¤©çš„è‡ªåŠ¨æ›´æ–°è®°å½•
          today_date=$(date '+%Y-%m-%d')
          
          # ç”ŸæˆèŠ‚ç‚¹è¯¦æƒ…æè¿°ï¼ˆç¡®ä¿æ ¼å¼ç»Ÿä¸€ï¼‰
          node_details="ğŸ“Š è‡ªåŠ¨æ›´æ–°"
          node_summary="èŠ‚ç‚¹æ›´æ–°"
          if [ "$yaml_nodes" -gt 0 ] && [ "$base64_lines" -gt 0 ]; then
            node_details="ğŸ“Š è‡ªåŠ¨æ›´æ–° - YAML:${yaml_nodes}ä¸ª, Base64:${base64_lines}ä¸ª"
            node_summary="YAML:${yaml_nodes}ä¸ª, Base64:${base64_lines}ä¸ª"
          elif [ "$yaml_nodes" -gt 0 ]; then
            node_details="ğŸ“Š è‡ªåŠ¨æ›´æ–° - YAML:${yaml_nodes}ä¸ª"
            node_summary="YAML:${yaml_nodes}ä¸ª"
          elif [ "$base64_lines" -gt 0 ]; then
            node_details="ğŸ“Š è‡ªåŠ¨æ›´æ–° - Base64:${base64_lines}ä¸ª"
            node_summary="Base64:${base64_lines}ä¸ª"
          fi
          
          echo "ğŸ” æ›´æ–°æ—¥å¿—å¤„ç†: æ—¶é—´=$current_date, èŠ‚ç‚¹è¯¦æƒ…=$node_details"
          
          # æ€»æ˜¯æ·»åŠ æ–°è®°å½•åˆ°è¡¨æ ¼å¤´éƒ¨ï¼ˆä¸å†æ£€æŸ¥é‡å¤ï¼‰
          echo "ğŸ“ æ·»åŠ æ–°çš„æ›´æ–°æ—¥å¿—è®°å½•..."
          sed -i '/|------|------|----------|/a\| '"$current_date"' | '"$node_summary"' | '"$node_details"' |' README.md
          
          # é™åˆ¶æ›´æ–°æ—¥å¿—è®°å½•æ•°é‡ä¸º10æ¡
          echo "ğŸ”§ æ¸…ç†è¶…å‡ºé™åˆ¶çš„æ—§è®°å½•..."
          awk '
          BEGIN { in_changelog = 0; record_count = 0 }
          /## ğŸ“‹ æ›´æ–°æ—¥å¿—/ { in_changelog = 1; print; next }
          /^## / && in_changelog && !/## ğŸ“‹ æ›´æ–°æ—¥å¿—/ { in_changelog = 0 }
          in_changelog && /^\|.*\|.*\|.*\|$/ && !/^|.*---|.*---|.*|$/ && !/æ—¶é—´.*èŠ‚ç‚¹æ•°é‡.*èŠ‚ç‚¹è¯¦æƒ…/ {
              record_count++
              if (record_count <= 10) print
              next
          }
          { print }
          ' README.md > README.md.tmp && mv README.md.tmp README.md
          
          echo "âœ… æ›´æ–°æ—¥å¿—è®°å½•å·²æ·»åŠ : $current_date - $node_summary"
          
          # éªŒè¯æ›´æ–°æ˜¯å¦æˆåŠŸ
          if grep -q "| ğŸ“„ \*\*YAML èŠ‚ç‚¹\*\* | $yaml_nodes ä¸ª |" README.md && grep -q "| ğŸ“ \*\*Base64 èŠ‚ç‚¹æ•°\*\* | $base64_lines ä¸ª |" README.md; then
            echo "âœ… README.md å®æ—¶ç»Ÿè®¡æ›´æ–°æˆåŠŸ"
          else
            echo "âŒ README.md å®æ—¶ç»Ÿè®¡æ›´æ–°å¤±è´¥ï¼Œå°è¯•æ¢å¤"
            if [ -f "README.md.backup" ]; then
              cp README.md.backup README.md
              echo "âœ… å·²ä»å¤‡ä»½æ¢å¤README.md"
            fi
          fi
          
          # éªŒè¯æ›´æ–°æ—¥å¿—æ˜¯å¦æ­£ç¡®æ·»åŠ 
          if grep -q "| $current_date.*ğŸ“Š è‡ªåŠ¨æ›´æ–°" README.md; then
            echo "âœ… æ›´æ–°æ—¥å¿—è®°å½•æ·»åŠ æˆåŠŸ"
          else
            echo "âš ï¸ æ›´æ–°æ—¥å¿—è®°å½•å¯èƒ½æ·»åŠ å¤±è´¥"
          fi
          
          echo "âœ… README.md æ›´æ–°å®Œæˆ"
        else
          echo "âŒ README.md æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡æ›´æ–°"
        fi
        
    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
        if [ -n "$(git status --porcelain)" ]; then
          git add .
          git commit -m "ğŸ”„ è‡ªåŠ¨æ›´æ–°èŠ‚ç‚¹æ–‡ä»¶ - $(date '+%Y-%m-%d %H:%M:%S')"
          git push
          echo "âœ… æ–‡ä»¶å·²æ›´æ–°å¹¶æ¨é€åˆ°ä»“åº“"
        else
          echo "â„¹ï¸ æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´"
        fi
      env:
        GITHUB_TOKEN: ${{ github.token }}
        
    - name: Create release summary
      run: |
        echo "## ğŸ“Š åŒæ­¥ç»“æœ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**åŒæ­¥æ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "**èŠ‚ç‚¹æ€»æ•°**: ${{ steps.count.outputs.total_nodes }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“ æ–‡ä»¶çŠ¶æ€" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        for file in nodes/*.yaml nodes/*.txt; do
          if [ -f "$file" ]; then
            filename=$(basename "$file")
            filesize=$(ls -lh "$file" | awk '{print $5}')
            echo "- âœ… **$filename**: $filesize" >> $GITHUB_STEP_SUMMARY
          fi
        done
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ğŸ‰ **åŒæ­¥å®Œæˆï¼æ‰€æœ‰æ–‡ä»¶å·²æˆåŠŸæ›´æ–°åˆ°ä»“åº“**" >> $GITHUB_STEP_SUMMARY