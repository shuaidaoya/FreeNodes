name: üîÑ ÂêåÊ≠• Gist ËäÇÁÇπÊñá‰ª∂

on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:
    inputs:
      dry_run:
        description: ÊºîÁªÉÊ®°ÂºèÔºà‰∏çÊèê‰∫§‰∏çÊé®ÈÄÅÔºâ
        type: boolean
        default: false
      force:
        description: Âº∫Âà∂ÊâßË°åÔºàÂøΩÁï•ÂÅ•Â∫∑Ê£ÄÊü•Ôºâ
        type: boolean
        default: false

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write
  actions: read
  issues: write

jobs:
  health:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      TZ: Asia/Shanghai
    steps:
      - name: üì¶ Ê£ÄÂá∫‰ª£Á†Å
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ github.token }}
          persist-credentials: true

      - name: üîç Ê£ÄÊü• Gist ÊòØÂê¶Êõ¥Êñ∞ÔºàÂåøÂêçÔºâ
        id: check
        run: |
          set -e
          echo "trigger_type=${{ github.event_name }}" >> $GITHUB_OUTPUT
          stored=""
          if [ -f README.md ]; then
            stored=$(grep -o "<!-- GIST_UPDATED_AT: .* -->" README.md | head -1 | sed -E 's/.*GIST_UPDATED_AT: ([^ ]+).*/\1/')
          fi
          api="https://api.github.com/gists/9e5cf2749c0ce79932dd9229d9b4162b"
          updated=$(curl -fsSL "$api" | python3 -c "import sys,json;print(json.load(sys.stdin).get('updated_at',''))")
          if [ -z "$updated" ]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "execution_reason=Êó†Ê≥ïËé∑Âèñ Gist Êõ¥Êñ∞Êó∂Èó¥Ôºå‰øùÂÆàÊâßË°å" >> $GITHUB_OUTPUT
          else
            if [ -z "$stored" ] || [ "$stored" != "$updated" ]; then
              echo "should_run=true" >> $GITHUB_OUTPUT
              echo "execution_reason=$( [ -z "$stored" ] && echo 'È¶ñÊ¨°ÊâßË°åÔºåÊú™ËÆ∞ÂΩï Gist ÁâàÊú¨' || echo 'Gist Â∑≤Êõ¥Êñ∞' )" >> $GITHUB_OUTPUT
            else
              echo "should_run=false" >> $GITHUB_OUTPUT
              echo "execution_reason=Gist Êú™Êõ¥Êñ∞ÔºåË∑≥ËøáÂêåÊ≠•" >> $GITHUB_OUTPUT
            fi
          fi
          echo "gist_updated_at=$updated" >> $GITHUB_OUTPUT
          echo "stored_gist_updated_at=$stored" >> $GITHUB_OUTPUT

      - name: üìä ÊâßË°åÁä∂ÊÄÅÊä•Âëä
        run: |
          echo "## üîç ÊâßË°åÁä∂ÊÄÅÊ£ÄÊü•" >> $GITHUB_STEP_SUMMARY
          echo "**Ëß¶ÂèëÊñπÂºè**: ${{ steps.check.outputs.trigger_type }}" >> $GITHUB_STEP_SUMMARY
          echo "**ÊâßË°åÂéüÂõ†**: ${{ steps.check.outputs.execution_reason }}" >> $GITHUB_STEP_SUMMARY
          echo "**Gist ÊúÄËøëÊõ¥Êñ∞Êó∂Èó¥**: ${{ steps.check.outputs.gist_updated_at }}" >> $GITHUB_STEP_SUMMARY
          echo "**‰∏äÊ¨°ËÆ∞ÂΩïÁöÑ Gist ÁâàÊú¨**: ${{ steps.check.outputs.stored_gist_updated_at }}" >> $GITHUB_STEP_SUMMARY
          echo "**ÊòØÂê¶ÈúÄË¶ÅÊâßË°å**: ${{ steps.check.outputs.should_run }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check.outputs.should_run }}" = "false" ]; then
            echo "‚è≠Ô∏è Êú¨Ê¨°ÊâßË°åÂ∞ÜË¢´Ë∑≥Ëøá" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ñ∂Ô∏è ÁªßÁª≠ÊâßË°åÊõ¥Êñ∞ÊµÅÁ®ã" >> $GITHUB_STEP_SUMMARY
          fi
    outputs:
      TRIGGER_TYPE: ${{ steps.check.outputs.trigger_type }}
      GIST_UPDATED_AT: ${{ steps.check.outputs.gist_updated_at }}
      STORED_GIST_UPDATED_AT: ${{ steps.check.outputs.stored_gist_updated_at }}
      SHOULD_RUN: ${{ steps.check.outputs.should_run }}
      EXECUTION_REASON: ${{ steps.check.outputs.execution_reason }}

  run-core:
    needs: health
    if: inputs.force == true || needs.health.outputs.SHOULD_RUN == 'true'
    uses: ./.github/workflows/sync-core.yml
    with:
      label: ‰∏ªÂêåÊ≠•
      gist_updated_at: ${{ needs.health.outputs.GIST_UPDATED_AT }}
      dry_run: ${{ inputs.dry_run || false }}
