name: ğŸ”„ å¤‡ç”¨åŒæ­¥ Gist èŠ‚ç‚¹æ–‡ä»¶

on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:
    inputs:
      dry_run:
        description: æ¼”ç»ƒæ¨¡å¼ï¼ˆä¸æäº¤ä¸æ¨é€ï¼‰
        type: boolean
        default: false
      force:
        description: å¼ºåˆ¶æ‰§è¡Œï¼ˆå¿½ç•¥å¥åº·æ£€æŸ¥ï¼‰
        type: boolean
        default: false

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  health:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      TZ: Asia/Shanghai
    outputs:
      SKIP_EXECUTION: ${{ steps.check.outputs.SKIP_EXECUTION }}
      FORCE_UPDATE: ${{ steps.check.outputs.FORCE_UPDATE }}
      TRIGGER_TYPE: ${{ steps.check.outputs.TRIGGER_TYPE }}
      EXECUTION_REASON: ${{ steps.check.outputs.EXECUTION_REASON }}
    steps:
      - name: ğŸ” å¤‡ç”¨å¥åº·æ£€æŸ¥ - é¿å…é‡å¤æ‰§è¡Œ
        id: check
        run: |
          echo "ğŸ” å¼€å§‹æ‰§è¡Œå¤‡ç”¨å¥åº·æ£€æŸ¥..."
          if [ -f "README.md" ]; then
            LAST_UPDATE=$(grep -o '[0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\} [0-9]\{2\}:[0-9]\{2\}:[0-9]\{2\}' README.md | tail -1)
            if [ -n "$LAST_UPDATE" ]; then
              CURRENT_TIME=$(date '+%Y-%m-%d %H:%M:%S')
              LAST_TIMESTAMP=$(date -d "$LAST_UPDATE" +%s 2>/dev/null || echo "0")
              CURRENT_TIMESTAMP=$(date -d "$CURRENT_TIME" +%s)
              TIME_DIFF=$(( (CURRENT_TIMESTAMP - LAST_TIMESTAMP) / 60 ))
              if [ "$TIME_DIFF" -lt 45 ]; then
                echo "SKIP_EXECUTION=true" >> $GITHUB_OUTPUT
                echo "EXECUTION_REASON=è·ç¦»ä¸Šæ¬¡æ›´æ–°ä»…${TIME_DIFF}åˆ†é’Ÿï¼Œä¸»è§¦å‘å™¨åº”è¯¥æ­£å¸¸å·¥ä½œ" >> $GITHUB_OUTPUT
              elif [ "$TIME_DIFF" -gt 90 ]; then
                echo "SKIP_EXECUTION=false" >> $GITHUB_OUTPUT
                echo "FORCE_UPDATE=true" >> $GITHUB_OUTPUT
                echo "EXECUTION_REASON=è¶…è¿‡90åˆ†é’Ÿæœªæ›´æ–°ï¼Œä¸»è§¦å‘å™¨å¯èƒ½å¤±æ•ˆï¼Œå¤‡ç”¨è§¦å‘å™¨æ¥ç®¡" >> $GITHUB_OUTPUT
              else
                echo "SKIP_EXECUTION=false" >> $GITHUB_OUTPUT
                echo "FORCE_UPDATE=false" >> $GITHUB_OUTPUT
                echo "EXECUTION_REASON=æ­£å¸¸å¤‡ç”¨æ‰§è¡Œé—´éš”(${TIME_DIFF}åˆ†é’Ÿ)" >> $GITHUB_OUTPUT
              fi
            else
              echo "SKIP_EXECUTION=false" >> $GITHUB_OUTPUT
              echo "FORCE_UPDATE=true" >> $GITHUB_OUTPUT
              echo "EXECUTION_REASON=æ— æ³•è·å–æ›´æ–°æ—¶é—´ï¼Œå¤‡ç”¨è§¦å‘å™¨å¼ºåˆ¶æ‰§è¡Œ" >> $GITHUB_OUTPUT
            fi
          else
            echo "SKIP_EXECUTION=false" >> $GITHUB_OUTPUT
            echo "FORCE_UPDATE=true" >> $GITHUB_OUTPUT
            echo "EXECUTION_REASON=README.mdä¸å­˜åœ¨ï¼Œå¤‡ç”¨è§¦å‘å™¨åˆå§‹åŒ–æ‰§è¡Œ" >> $GITHUB_OUTPUT
          fi
          echo "TRIGGER_TYPE=${{ github.event_name }}" >> $GITHUB_OUTPUT

      - name: ğŸ“Š å¤‡ç”¨æ‰§è¡ŒçŠ¶æ€æŠ¥å‘Š
        run: |
          echo "## ğŸ”„ å¤‡ç”¨è§¦å‘å™¨æ‰§è¡ŒçŠ¶æ€" >> $GITHUB_STEP_SUMMARY
          echo "**è§¦å‘æ–¹å¼**: ${{ steps.check.outputs.TRIGGER_TYPE }}" >> $GITHUB_STEP_SUMMARY
          echo "**æ‰§è¡ŒåŸå› **: ${{ steps.check.outputs.EXECUTION_REASON }}" >> $GITHUB_STEP_SUMMARY
          echo "**æ˜¯å¦è·³è¿‡**: ${{ steps.check.outputs.SKIP_EXECUTION }}" >> $GITHUB_STEP_SUMMARY
          echo "**å¼ºåˆ¶æ›´æ–°**: ${{ steps.check.outputs.FORCE_UPDATE }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check.outputs.SKIP_EXECUTION }}" = "true" ]; then
            echo "â­ï¸ å¤‡ç”¨è§¦å‘å™¨è·³è¿‡æ‰§è¡Œï¼ˆä¸»è§¦å‘å™¨æ­£å¸¸å·¥ä½œï¼‰" >> $GITHUB_STEP_SUMMARY
          else
            echo "ğŸš¨ å¤‡ç”¨è§¦å‘å™¨æ¥ç®¡æ‰§è¡Œï¼ˆä¸»è§¦å‘å™¨å¯èƒ½å¤±æ•ˆï¼‰" >> $GITHUB_STEP_SUMMARY
          fi

  run-core:
    needs: health
    if: inputs.force == true || needs.health.outputs.SKIP_EXECUTION != 'true'
    uses: ./.github/workflows/sync-core.yml
    with:
      label: å¤‡ç”¨åŒæ­¥
      dry_run: ${{ inputs.dry_run }}
