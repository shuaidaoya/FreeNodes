name: âš™ï¸ Sync Core Workflow

on:
  workflow_call:
    inputs:
      label:
        description: æ‰§è¡Œæ ‡ç­¾ï¼ˆä¸»åŒæ­¥/å¤‡ç”¨/ç´§æ€¥ï¼‰
        required: false
        default: ä¸»åŒæ­¥
        type: string
      gist_updated_at:
        description: Gist æœ€è¿‘æ›´æ–°æ—¶é—´ï¼ˆISO 8601ï¼‰
        required: false
        default: ''
        type: string
      dry_run:
        description: æ¼”ç»ƒæ¨¡å¼ï¼ˆä¸æäº¤ä¸æŽ¨é€ï¼‰
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  issues: write

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      TZ: Asia/Shanghai
    steps:
      - name: ðŸ“¦ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ github.token }}
          persist-credentials: true

      - name: ðŸ—‚ï¸ å‡†å¤‡ç›®å½•
        run: |
          mkdir -p nodes

      - name: ðŸ“¥ ä¸‹è½½ Gist æ–‡ä»¶ï¼ˆç¨³å¥ï¼‰
        id: download
        run: |
          set -e
          GIST_BASE_URL="https://gist.githubusercontent.com/shuaidaoya/9e5cf2749c0ce79932dd9229d9b4162b/raw"

          download() {
            url="$1"; out="$2"
            echo "âž¡ï¸ ä¸‹è½½ $url -> $out"
            if ! curl -fS --connect-timeout 10 --max-time 60 --retry 5 --retry-delay 5 "$url" -o "$out"; then
              echo "âŒ ä¸‹è½½å¤±è´¥: $url" >&2
              echo "failed=true" >> $GITHUB_OUTPUT
              return 1
            fi
            if [ ! -s "$out" ]; then
              echo "âŒ æ–‡ä»¶ä¸ºç©º: $out" >&2
              echo "failed=true" >> $GITHUB_OUTPUT
              return 1
            fi
          }

          download "$GIST_BASE_URL/all.yaml" nodes/all.yaml || true
          download "$GIST_BASE_URL/base64.txt" nodes/base64.txt || true
          download "$GIST_BASE_URL/history.yaml" nodes/history.yaml || true
          download "$GIST_BASE_URL/mihomo.yaml" nodes/mihomo.yaml || true

          echo "label=${{ inputs.label }}" >> $GITHUB_OUTPUT

      - name: ðŸ“ åˆ—å‡º nodes æ–‡ä»¶ä¸Žæ ¡éªŒå“ˆå¸Œ
        run: |
          echo "### nodes æ–‡ä»¶åˆ—è¡¨" >> $GITHUB_STEP_SUMMARY
          if ls -lh nodes/* 1>/dev/null 2>&1; then
            ls -lh nodes/* | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### nodes æ–‡ä»¶ SHA256" >> $GITHUB_STEP_SUMMARY
            for f in nodes/*; do
              [ -f "$f" ] && echo "- $(sha256sum "$f")" >> $GITHUB_STEP_SUMMARY || true
            done
          else
            echo "- æ— æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ðŸ§® ç»Ÿè®¡èŠ‚ç‚¹
        id: count
        run: |
          yaml_nodes=0
          base64_lines=0

          if [ -s nodes/all.yaml ]; then
            yaml_nodes=$(grep -c "server:" nodes/all.yaml 2>/dev/null || echo 0)
          fi

          if [ -s nodes/base64.txt ]; then
            decoded_content=$(base64 -d nodes/base64.txt 2>/dev/null || echo "")
            if [ -n "$decoded_content" ]; then
              base64_lines=$(echo "$decoded_content" | grep -c "^[a-zA-Z0-9]*://" 2>/dev/null || echo 0)
            fi
          fi

          echo "yaml_nodes=$yaml_nodes" >> $GITHUB_OUTPUT
          echo "base64_lines=$base64_lines" >> $GITHUB_OUTPUT

      - name: ðŸ“ ç”Ÿæˆ nodes/README.md
        run: |
          echo "# ðŸ“Š èŠ‚ç‚¹æ–‡ä»¶ä¿¡æ¯" > nodes/README.md
          echo "" >> nodes/README.md
          echo "**æ›´æ–°æ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S åŒ—äº¬æ—¶é—´')" >> nodes/README.md
          echo "**æ›´æ–°æ–¹å¼**: ${{ inputs.label }}" >> nodes/README.md
          echo "" >> nodes/README.md
          echo "| æ–‡ä»¶å | å¤§å° | æœ€åŽä¿®æ”¹ |" >> nodes/README.md
          echo "|--------|------|----------|" >> nodes/README.md
          for file in nodes/*.yaml nodes/*.txt; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              filesize=$(ls -lh "$file" | awk '{print $5}')
              modified=$(date -r "$file" '+%Y-%m-%d %H:%M')
              echo "| $filename | $filesize | $modified |" >> nodes/README.md
            fi
          done

      - name: ðŸ“¦ ä¸Šä¼  nodes ç›®å½•ä¸º artifact
        uses: actions/upload-artifact@v4
        with:
          name: nodes-files
          path: nodes

      - name: ðŸ•’ èŽ·å– Gist æ›´æ–°æ—¶é—´
        id: gist
        run: |
          set -e
          api="https://api.github.com/gists/9e5cf2749c0ce79932dd9229d9b4162b"
          updated=$(curl -fsSL "$api" | python3 -c "import sys,json;print(json.load(sys.stdin).get('updated_at',''))")
          echo "updated_at=$updated" >> $GITHUB_OUTPUT

      - name: âš™ï¸ æ›´æ–° README ç»Ÿè®¡ï¼ˆè„šæœ¬ï¼‰
        shell: pwsh
        run: |
          $yamlNodes = '${{ steps.count.outputs.yaml_nodes }}'
          $base64Lines = '${{ steps.count.outputs.base64_lines }}'
          $label = '${{ inputs.label }}'
          $gistUpdatedAt = '${{ inputs.gist_updated_at }}'
          if ([string]::IsNullOrWhiteSpace($gistUpdatedAt)) { $gistUpdatedAt = '${{ steps.gist.outputs.updated_at }}' }
          ./.github/scripts/update_readme.ps1 -YamlNodes $yamlNodes -Base64Lines $base64Lines -Label $label -ReadmePath 'README.md' -GistUpdatedAt $gistUpdatedAt

      - name: ðŸ” é…ç½® Git ç”¨æˆ·
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: ðŸ” æäº¤å‰çŠ¶æ€æ£€æŸ¥
        run: |
          echo "### Git çŠ¶æ€" >> $GITHUB_STEP_SUMMARY
          git status --porcelain || true
          git status --porcelain | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### å˜æ›´æ–‡ä»¶åˆ—è¡¨" >> $GITHUB_STEP_SUMMARY
          git diff --name-only || true
          git diff --name-only | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY

      - name: ðŸš€ æäº¤ä¸ŽæŽ¨é€ï¼ˆä»…æœ‰å˜æ›´ï¼‰
        if: inputs.dry_run != true
        run: |
          set -e
          if [ -f README.md ]; then
            printf '\n' >> README.md
          fi
          if [ -z "$(git status --porcelain)" ]; then
            echo "æ— å˜æ›´ï¼Œè·³è¿‡æäº¤"
            exit 0
          fi
          git add .
          git commit -m "ðŸ”„ è‡ªåŠ¨åŒæ­¥ï¼ˆ${{ inputs.label }}ï¼‰ - $(date '+%Y-%m-%d %H:%M:%S')"
          git pull --rebase || true
          git push

      - name: âŒ å¤±è´¥é€šçŸ¥ï¼ˆä¸‹è½½æˆ–æäº¤å¤±è´¥æ—¶ï¼‰
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const { rest } = github;
            const title = `Sync Failure - Run ${context.runId}`;
            const body = `Workflow: ${context.workflow}\nRun ID: ${context.runId}\nJob: ${context.job}\nCheck summary for details.`;
            // æŸ¥æ‰¾å½“å¤©æ˜¯å¦å·²æœ‰ issue
            const list = await rest.issues.listForRepo({ owner: context.repo.owner, repo: context.repo.repo, labels: 'sync-failure', state: 'open' });
            const existing = list.data.find(i => i.title.includes('Sync Failure'));
            if (existing) {
              await rest.issues.createComment({ owner: context.repo.owner, repo: context.repo.repo, issue_number: existing.number, body });
            } else {
              const created = await rest.issues.create({ owner: context.repo.owner, repo: context.repo.repo, title, body, labels: ['sync-failure'] });
              core.info(`Created issue #${created.data.number}`);
            }

      - name: ðŸ§ª æ¼”ç»ƒæ¨¡å¼è¾“å‡º
        if: inputs.dry_run == true
        run: |
          echo "DRY_RUN æ¨¡å¼ï¼šä¸æäº¤ä¸æŽ¨é€ï¼Œä»…éªŒè¯æµç¨‹"

      - name: ðŸ“‹ æ­¥éª¤æ€»ç»“
        run: |
          echo "## åŒæ­¥æ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "- æ ‡ç­¾: ${{ inputs.label }}" >> $GITHUB_STEP_SUMMARY
          echo "- YAML èŠ‚ç‚¹: ${{ steps.count.outputs.yaml_nodes }}" >> $GITHUB_STEP_SUMMARY
          echo "- Base64 èŠ‚ç‚¹: ${{ steps.count.outputs.base64_lines }}" >> $GITHUB_STEP_SUMMARY
          echo "- DRY_RUN: ${{ inputs.dry_run }}" >> $GITHUB_STEP_SUMMARY
